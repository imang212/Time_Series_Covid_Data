<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Patrik Poklop, Tomáš Ladislav Kotek">

<title>Analýza covid dat</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="covid_data_analyse_files/libs/clipboard/clipboard.min.js"></script>
<script src="covid_data_analyse_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="covid_data_analyse_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="covid_data_analyse_files/libs/quarto-html/popper.min.js"></script>
<script src="covid_data_analyse_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="covid_data_analyse_files/libs/quarto-html/anchor.min.js"></script>
<link href="covid_data_analyse_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="covid_data_analyse_files/libs/quarto-html/quarto-syntax-highlighting-d9589ad4e98504035195c70aa99e1e7d.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="covid_data_analyse_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="covid_data_analyse_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="covid_data_analyse_files/libs/bootstrap/bootstrap-bb462d781dde1847d9e3ccf7736099dd.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Analýza covid dat</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Patrik Poklop, Tomáš Ladislav Kotek </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<style>
#quarto-content {
  display: flex;
  align-content: center;
}
main {
  max-width: 1000px;
  margin-left: auto;
  margin-right: auto;
}
</style>
<section id="analýza-covid-dat-na-časové-řady" class="level1">
<h1>Analýza covid dat na časové řady</h1>
<section id="načtení-dat" class="level2">
<h2 class="anchored" data-anchor-id="načtení-dat">Načtení dat</h2>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.4     ✔ readr     2.1.5
✔ forcats   1.0.0     ✔ stringr   1.5.2
✔ ggplot2   4.0.0     ✔ tibble    3.3.0
✔ lubridate 1.9.4     ✔ tidyr     1.3.1
✔ purrr     1.1.0     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors
Registered S3 method overwritten by 'quantmod':
  method            from
  as.zoo.data.frame zoo 

corrplot 0.95 loaded


Attaching package: 'gridExtra'


The following object is masked from 'package:dplyr':

    combine



Attaching package: 'seasonal'


The following object is masked from 'package:tibble':

    view


Loading required package: MASS


Attaching package: 'MASS'


The following object is masked from 'package:dplyr':

    select


Loading required package: strucchange

Loading required package: zoo


Attaching package: 'zoo'


The following objects are masked from 'package:base':

    as.Date, as.Date.numeric


Loading required package: sandwich


Attaching package: 'strucchange'


The following object is masked from 'package:stringr':

    boundary


Loading required package: urca

Loading required package: lmtest</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "C"</code></pre>
</div>
</div>
</section>
<section id="úvod" class="level2">
<h2 class="anchored" data-anchor-id="úvod">Úvod</h2>
<p>V této analýze se zaměřujem na hledání optimálního modelu pro časovou řadu COVID-19 dat od 5.1.2020 do 8.4.2024. Cílem je otestovat různé přístupy k modelování časových řad a najít ten, který nejlépe popisuje data a poskytuje nejpřesnější predikce.</p>
<p>Analýza postupu je systematicky přes několik kroků: Explorativní analýza - grafické zobrazení a identifikace základních charakteristik:</p>
<ul>
<li><p>Dekompozice - rozdělení řady na trend, sezónní a náhodnou složku</p></li>
<li><p>Funkční modelování - hledání matematické funkce popisující trend a sezónnost</p></li>
<li><p>SARIMA modelování - autoregresní přístup zachycující časovou závislost</p></li>
<li><p>Multivariátní modelování - zahrnutí vlivu ostatních proměnných</p></li>
<li><p>Srovnání a validace - výběr nejlepšího modelu na základě kritérií</p></li>
</ul>
<p>Jako hlavní řadu jsme zvolili new_cases(nové případy COVID-19), protože:</p>
<ul>
<li><p>Má výrazný dlouhodobý trend (růst během pandemie).</p></li>
<li><p>Vykazuje sezónní chování (vyšší hodnoty v zimních měsících).</p></li>
<li><p>Je klíčovou metrikou pro epidemiologické sledování.</p></li>
<li><p>Má dostupná kvalitní data bez příliš mnoha chybějících hodnot.</p></li>
</ul>
</section>
<section id="převod-dat-na-časovou-řadu" class="level2">
<h2 class="anchored" data-anchor-id="převod-dat-na-časovou-řadu">Převod dat na časovou řadu</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Převod datumu na správný formát</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(data<span class="sc">$</span>date)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Kontrola chybějících hodnot v new_cases</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Chybějící hodnoty v new_cases:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Chybějící hodnoty v new_cases:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>missing_summary <span class="ot">&lt;-</span> <span class="fu">sapply</span>(data<span class="sc">$</span>new_cases, <span class="cf">function</span>(x) <span class="fu">sum</span>(<span class="fu">is.na</span>(x)))</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(missing_summary[missing_summary <span class="sc">&gt;</span> <span class="dv">0</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1 1 1 1 1 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Chybějící hodnoty v dates:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Chybějící hodnoty v dates:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>missing_summary <span class="ot">&lt;-</span> <span class="fu">sapply</span>(data<span class="sc">$</span>date, <span class="cf">function</span>(x) <span class="fu">sum</span>(<span class="fu">is.na</span>(x)))</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(missing_summary[missing_summary <span class="sc">&gt;</span> <span class="dv">0</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>integer(0)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Kontrola new_cases sloupce</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Souhrn new_cases sloupce:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Souhrn new_cases sloupce:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">summary</span>(data<span class="sc">$</span>new_cases))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Min.  1st Qu.   Median     Mean  3rd Qu.     Max.     NA's 
       0        0        0     8496        0 44236227    18431 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Odstranění řádků s chybějícími hodnotami v new_cases</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>original_rows <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> data[<span class="sc">!</span><span class="fu">is.na</span>(data<span class="sc">$</span>new_cases), ]</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Odstraněno"</span>, original_rows <span class="sc">-</span> <span class="fu">nrow</span>(data), <span class="st">"řádků s chybějícími hodnotami v new_cases</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Odstraněno 18431 řádků s chybějícími hodnotami v new_cases</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Vytvoření měsíc-rok proměnné</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>year_month <span class="ot">&lt;-</span> <span class="fu">format</span>(data<span class="sc">$</span>date, <span class="st">"%Y-%m"</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>year <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">format</span>(data<span class="sc">$</span>date, <span class="st">"%Y"</span>))</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>month <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">format</span>(data<span class="sc">$</span>date, <span class="st">"%m"</span>))</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Agregace na měsíční součty</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>monthly_data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year, month, year_month) <span class="sc">%&gt;%</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">new_cases =</span> <span class="fu">sum</span>(new_cases, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">new_deaths =</span> <span class="fu">sum</span>(new_deaths, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">stringency_index =</span> <span class="fu">mean</span>(stringency_index, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">hosp_patients =</span> <span class="fu">mean</span>(hosp_patients, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">reproduction_rate =</span> <span class="fu">mean</span>(reproduction_rate, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> <span class="fu">max</span>(date),  <span class="co"># poslední den měsíce jako reprezentant</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">'drop'</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(year, month)</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Počet měsíčních pozorování:"</span>, <span class="fu">nrow</span>(monthly_data), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Počet měsíčních pozorování: 56 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Rozsah dat:"</span>, <span class="fu">range</span>(monthly_data<span class="sc">$</span>date), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rozsah dat: 18292 19939 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>year <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">format</span>(data<span class="sc">$</span>date, <span class="st">"%Y"</span>))</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>week <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">format</span>(data<span class="sc">$</span>date, <span class="st">"%U"</span>))  <span class="co"># týden v roce (0-53)</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>year_week <span class="ot">&lt;-</span> <span class="fu">paste</span>(data<span class="sc">$</span>year, <span class="fu">sprintf</span>(<span class="st">"%02d"</span>, data<span class="sc">$</span>week), <span class="at">sep =</span> <span class="st">"-W"</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year, week, year_week) <span class="sc">%&gt;%</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">new_cases =</span> <span class="fu">sum</span>(new_cases, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">new_deaths =</span> <span class="fu">sum</span>(new_deaths, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">stringency_index =</span> <span class="fu">mean</span>(stringency_index, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">hosp_patients =</span> <span class="fu">mean</span>(hosp_patients, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">reproduction_rate =</span> <span class="fu">mean</span>(reproduction_rate, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> <span class="fu">max</span>(date),  <span class="co"># poslední den týdne jako reprezentant</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">'drop'</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(year, week) <span class="sc">%&gt;%</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(week <span class="sc">&gt;</span> <span class="dv">0</span>)  <span class="co"># odstraníme týden 0 (může být neúplný)</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Vytvoření časové řady</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Data začínají od: "</span>,<span class="fu">as.numeric</span>(<span class="fu">format</span>(<span class="fu">min</span>(data<span class="sc">$</span>date), <span class="st">"%d"</span>)) , <span class="fu">as.numeric</span>(<span class="fu">format</span>(<span class="fu">min</span>(data<span class="sc">$</span>date), <span class="st">"%m"</span>)), <span class="fu">as.numeric</span>(<span class="fu">format</span>(<span class="fu">min</span>(data<span class="sc">$</span>date), <span class="st">"%Y"</span>)), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Data začínají od:  11 1 2020 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Data končí: "</span>, <span class="fu">as.numeric</span>(<span class="fu">format</span>(<span class="fu">max</span>(data<span class="sc">$</span>date), <span class="st">"%d"</span>)), <span class="fu">as.numeric</span>(<span class="fu">format</span>(<span class="fu">max</span>(data<span class="sc">$</span>date), <span class="st">"%m"</span>)),<span class="fu">as.numeric</span>(<span class="fu">format</span>(<span class="fu">max</span>(data<span class="sc">$</span>date), <span class="st">"%Y"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Data končí:  4 8 2024</code></pre>
</div>
</div>
<p>Nejdřív než se data převedli na časovou řadu, zkontrolovalo se, jestli nejsou chybějící hodnoty ve sloupcích, které se budou analyzovat. Zkontrovalo se, jestli nejsou v datech mezery, kolik mají pozorování a jaký je v nich rozsah hodnot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(data<span class="sc">$</span>date, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2024-08-04"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>start_year <span class="ot">&lt;-</span> <span class="fu">min</span>(monthly_data<span class="sc">$</span>year)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>start_month <span class="ot">&lt;-</span> <span class="fu">min</span>(monthly_data<span class="sc">$</span>month[monthly_data<span class="sc">$</span>year <span class="sc">==</span> start_year])</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>ts_data <span class="ot">&lt;-</span> <span class="fu">ts</span>(monthly_data<span class="sc">$</span>new_cases, <span class="at">start =</span> <span class="fu">c</span>(start_year, start_month), <span class="at">frequency =</span> <span class="dv">12</span>)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Počet pozorování:"</span>, <span class="fu">length</span>(ts_data), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Počet pozorování: 56 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Rozsah hodnot:"</span>, <span class="fu">round</span>(<span class="fu">range</span>(ts_data, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rozsah hodnot: 8140 411925725 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ts_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
     8140   3766099  40401988  58721292  81579755 411925725 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(ts_data, <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          Jan      Feb      Mar      Apr      May      Jun      Jul      Aug
2020     8140   304998  2775012  8618449 12841220 15852831 24432576 37569280
2021 92908283 46707757 55241813 82185491 97179059 43778574 54942256 91155689
          Sep      Oct      Nov      Dec
2020 33477707 43234697 84397006 72463936
2021                                    </code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(ts_data, <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           Jan       Feb       Mar       Apr       May       Jun       Jul
2023 192447750  20376753  15442023  15183732   7906166   3833115   4562493
2024   2740112   1429627   1444016    601461    557549    811610    906906
           Aug       Sep       Oct       Nov       Dec
2023   6236380   3565052   3413884   3426225   7074288
2024    214317                                        </code></pre>
</div>
</div>
<p>Vytvořili jsme časovou řadu v určitém daném rozmezí.</p>
</section>
<section id="grafické-zobrazení-řady" class="level2">
<h2 class="anchored" data-anchor-id="grafické-zobrazení-řady">Grafické zobrazení řady</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Grafické zobrazení hlavní řady</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(monthly_data, <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> new_cases)) <span class="sc">+</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"steelblue"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"loess"</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Vývoj nových případů COVID-19"</span>,</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Datum"</span>, <span class="at">y =</span> <span class="st">"Počet nových případů"</span>,</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Měsíční agregace denních dat s trendem (červená linie)"</span>) <span class="sc">+</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Boxplot podle měsíců pro identifikaci sezónnosti</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(monthly_data, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(month), <span class="at">y =</span> new_cases)) <span class="sc">+</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">fill =</span> <span class="st">"lightblue"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">position =</span> <span class="fu">position_jitter</span>(<span class="at">width =</span> <span class="fl">0.2</span>)) <span class="sc">+</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="at">labels =</span> month.abb) <span class="sc">+</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Sezónní rozdělení měsíčních případů"</span>,</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Měsíc"</span>, <span class="at">y =</span> <span class="st">"Počet nových případů"</span>) <span class="sc">+</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(p1, p2, <span class="at">ncol =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="covid_data_analyse_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="3840"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="dekompozice-a-identifikace-trendu" class="level2">
<h2 class="anchored" data-anchor-id="dekompozice-a-identifikace-trendu">Dekompozice a identifikace trendu</h2>
<section id="dekompozice-časové-řady" class="level4">
<h4 class="anchored" data-anchor-id="dekompozice-časové-řady">Dekompozice časové řady</h4>
<p>Dekompozice umožňuje pochopit strukturu dat, identifikuje sílu trendové vs.&nbsp;sezónní složky a pomáhá při výběru vhodného typu modelu (aditivní vs.&nbsp;multiplikativní). STL dekompozice je robustní, flexibilní metoda vhodná pro dlouhé časové řady.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># STL dekompozice</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>stl_decomp <span class="ot">&lt;-</span> <span class="fu">stl</span>(ts_data, <span class="at">s.window =</span> <span class="st">"periodic"</span>, <span class="at">t.window =</span> <span class="cn">NULL</span>, <span class="at">robust =</span> <span class="cn">TRUE</span>)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(stl_decomp, <span class="at">main =</span> <span class="st">"STL dekompozice časové řady nových případů"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="covid_data_analyse_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="3840"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="identifikace-trendu-pomocí-vyhlazení" class="level4">
<h4 class="anchored" data-anchor-id="identifikace-trendu-pomocí-vyhlazení">Identifikace trendu pomocí vyhlazení</h4>
<ul>
<li>MA(4): Měsíční vyhlazení - zobrazí střednědobé trendy</li>
<li>MA(52): Roční vyhlazení - zachytí dlouhodobý trend</li>
<li>Exponenciální vyhlazení: Dává vyšší váhu novějším pozorováním, vhodné pro predikci</li>
</ul>
<p>Výsledky říkají, která metoda nejlépe zachycuje základní trend, jak silné jsou krátkodobé vs.&nbsp;dlouhodobé fluktuace, zda je trend stabilní nebo se mění v čase.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>start_week <span class="ot">&lt;-</span> <span class="fu">min</span>(data<span class="sc">$</span>week[data<span class="sc">$</span>year <span class="sc">==</span> start_year])</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>ts_weekly_data <span class="ot">&lt;-</span> <span class="fu">ts</span>(data<span class="sc">$</span>new_cases, <span class="at">start =</span> <span class="fu">c</span>(start_year, start_week), <span class="at">frequency =</span> <span class="dv">52</span>)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Klouzavé průměry různých řádů</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>ma_4 <span class="ot">&lt;-</span> <span class="fu">SMA</span>(data<span class="sc">$</span>new_cases, <span class="at">n =</span> <span class="dv">4</span>) </span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>ma_52 <span class="ot">&lt;-</span> <span class="fu">SMA</span>(data<span class="sc">$</span>new_cases, <span class="at">n =</span> <span class="dv">52</span>) </span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Exponenciální vyrovnání - jednodušší přístup</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>exp_smooth_model <span class="ot">&lt;-</span> <span class="fu">HoltWinters</span>(ts_weekly_data, <span class="at">gamma =</span> <span class="cn">FALSE</span>)</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Vytvoříme jednoduché exponenciální vyhlazení pomocí ETS</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>ets_model <span class="ot">&lt;-</span> <span class="fu">ets</span>(ts_weekly_data, <span class="at">model =</span> <span class="st">"AAN"</span>, <span class="at">damped =</span> <span class="cn">FALSE</span>)</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>exp_smooth_fitted <span class="ot">&lt;-</span> <span class="fu">fitted</span>(ets_model)</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Zajistíme stejnou délku (ETS vrací stejnou délku jako originální data)</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>n_obs <span class="ot">&lt;-</span> <span class="fu">length</span>(data<span class="sc">$</span>new_cases)</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Pokud je exp_smooth_fitted kratší, doplníme NA na začátek</span></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">length</span>(exp_smooth_fitted) <span class="sc">&lt;</span> n_obs) {</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>  exp_smooth_full <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="cn">NA</span>, n_obs <span class="sc">-</span> <span class="fu">length</span>(exp_smooth_fitted)), </span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">as.numeric</span>(exp_smooth_fitted))</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>  exp_smooth_full <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(exp_smooth_fitted[<span class="dv">1</span><span class="sc">:</span>n_obs])</span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Grafické srovnání - pouze metody, které máme</span></span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>trend_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">date =</span> data<span class="sc">$</span>date,</span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">original =</span> data<span class="sc">$</span>new_cases,</span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">ma_4 =</span> ma_4,</span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">ma_52 =</span> ma_52,</span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">exp_smooth =</span> exp_smooth_full</span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Přidáme exponenciální vyhlazení</span></span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a>trend_data<span class="sc">$</span>exp_smooth <span class="ot">&lt;-</span> exp_smooth_full</span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-38"><a href="#cb39-38" aria-hidden="true" tabindex="-1"></a>trend_plot <span class="ot">&lt;-</span> trend_data <span class="sc">%&gt;%</span></span>
<span id="cb39-39"><a href="#cb39-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>date, <span class="at">names_to =</span> <span class="st">"method"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb39-40"><a href="#cb39-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(value)) <span class="sc">%&gt;%</span>  <span class="co"># Odfiltrujeme NA hodnoty</span></span>
<span id="cb39-41"><a href="#cb39-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> value, <span class="at">color =</span> method)) <span class="sc">+</span></span>
<span id="cb39-42"><a href="#cb39-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">size =</span> <span class="fl">0.65</span>) <span class="sc">+</span></span>
<span id="cb39-43"><a href="#cb39-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"original"</span> <span class="ot">=</span> <span class="st">"gray50"</span>, <span class="st">"ma_4"</span> <span class="ot">=</span> <span class="st">"blue"</span>, <span class="st">"ma_52"</span> <span class="ot">=</span> <span class="st">"red"</span>, <span class="st">"exp_smooth"</span> <span class="ot">=</span> <span class="st">"purple"</span>),</span>
<span id="cb39-44"><a href="#cb39-44" aria-hidden="true" tabindex="-1"></a>                     <span class="at">name =</span> <span class="st">"Metoda"</span>,</span>
<span id="cb39-45"><a href="#cb39-45" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"original"</span> <span class="ot">=</span> <span class="st">"Originální data"</span>, </span>
<span id="cb39-46"><a href="#cb39-46" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"ma_4"</span> <span class="ot">=</span> <span class="st">"MA(4)"</span>, </span>
<span id="cb39-47"><a href="#cb39-47" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"ma_52"</span> <span class="ot">=</span> <span class="st">"MA(52)"</span>, <span class="st">"exp_smooth"</span> <span class="ot">=</span> <span class="st">"Exp. vyhlazení"</span>)) <span class="sc">+</span></span>
<span id="cb39-48"><a href="#cb39-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Srovnání metod vyhlazení trendu"</span>,</span>
<span id="cb39-49"><a href="#cb39-49" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Datum"</span>, <span class="at">y =</span> <span class="st">"Hodnota"</span>) <span class="sc">+</span></span>
<span id="cb39-50"><a href="#cb39-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb39-51"><a href="#cb39-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb39-52"><a href="#cb39-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-53"><a href="#cb39-53" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(trend_plot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="covid_data_analyse_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="3840"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Analýza trendové složky</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>trend_component <span class="ot">&lt;-</span> stl_decomp<span class="sc">$</span>time.series[,<span class="st">"trend"</span>]</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Souhrn trendové složky:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Souhrn trendové složky:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">summary</span>(trend_component))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
  804251  8284307 35011468 33280105 57619931 63609622 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Analýza sezónní složky</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>seasonal_component <span class="ot">&lt;-</span> stl_decomp<span class="sc">$</span>time.series[,<span class="st">"seasonal"</span>]</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Souhrn sezónní složky:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Souhrn sezónní složky:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">summary</span>(seasonal_component))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
-6029877 -4628778 -2933429  -512658    50004 25398586 </code></pre>
</div>
</div>
</section>
</section>
<section id="hledání-optimálního-funkčního-modelu-trend-sezónnost" class="level2">
<h2 class="anchored" data-anchor-id="hledání-optimálního-funkčního-modelu-trend-sezónnost">Hledání optimálního funkčního modelu (trend + sezónnost)</h2>
<p>Testování různých modelů s kombinacemi, jejich srovnání a grafické zobrazení fitování.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Příprava dat pro regresní model</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>t <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>sin_365 <span class="ot">&lt;-</span> <span class="fu">sin</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> data<span class="sc">$</span>t <span class="sc">/</span> <span class="dv">52</span>)</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>cos_365 <span class="ot">&lt;-</span> <span class="fu">cos</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> data<span class="sc">$</span>t <span class="sc">/</span> <span class="dv">52</span>)</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>sin_7 <span class="ot">&lt;-</span> <span class="fu">sin</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> data<span class="sc">$</span>t <span class="sc">/</span> <span class="dv">4</span>)</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>cos_7 <span class="ot">&lt;-</span> <span class="fu">cos</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> data<span class="sc">$</span>t <span class="sc">/</span> <span class="dv">4</span>)</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>sin_1 <span class="ot">&lt;-</span> <span class="fu">sin</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> data<span class="sc">$</span>t <span class="sc">/</span> <span class="dv">1</span>)</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>cos_1 <span class="ot">&lt;-</span> <span class="fu">cos</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> data<span class="sc">$</span>t <span class="sc">/</span> <span class="dv">1</span>)</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 1: Lineární trend + roční sezónnost</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>model1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(new_cases <span class="sc">~</span> t <span class="sc">+</span> sin_365 <span class="sc">+</span> cos_365, <span class="at">data =</span> data)</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 2: Polynomiální trend + roční sezónnost</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>model2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(new_cases <span class="sc">~</span> <span class="fu">poly</span>(t, <span class="dv">2</span>) <span class="sc">+</span> sin_365 <span class="sc">+</span> cos_365, <span class="at">data =</span> data)</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 3: Lineární trend + roční + měsíční sezónnost</span></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>model3 <span class="ot">&lt;-</span> <span class="fu">lm</span>(new_cases <span class="sc">~</span> t <span class="sc">+</span> sin_365 <span class="sc">+</span> cos_365 <span class="sc">+</span> sin_7 <span class="sc">+</span> cos_7, <span class="at">data =</span> data)</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 4: Polynomiální trend + roční + měsíční sezónnost</span></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>model4 <span class="ot">&lt;-</span> <span class="fu">lm</span>(new_cases <span class="sc">~</span> <span class="fu">poly</span>(t, <span class="dv">2</span>) <span class="sc">+</span> sin_365 <span class="sc">+</span> cos_365 <span class="sc">+</span> sin_7 <span class="sc">+</span> cos_7, <span class="at">data =</span> data)</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 5: Polynomiální trend + roční + měsíční + týdenní sezónnost</span></span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>model5 <span class="ot">&lt;-</span> <span class="fu">lm</span>(new_cases <span class="sc">~</span> <span class="fu">poly</span>(t, <span class="dv">2</span>) <span class="sc">+</span> sin_365 <span class="sc">+</span> cos_365 <span class="sc">+</span> sin_7 <span class="sc">+</span> cos_7 <span class="sc">+</span> sin_1 <span class="sc">+</span> cos_1, <span class="at">data =</span> data)</span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 6: Polynomiální trend + roční + týdenní sezónnost</span></span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>model6 <span class="ot">&lt;-</span> <span class="fu">lm</span>(new_cases <span class="sc">~</span> <span class="fu">poly</span>(t, <span class="dv">2</span>) <span class="sc">+</span> sin_365 <span class="sc">+</span> cos_365 <span class="sc">+</span> sin_1 <span class="sc">+</span> cos_1, <span class="at">data =</span> data)</span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Srovnání modelů</span></span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>models <span class="ot">&lt;-</span> <span class="fu">list</span>(model1, model2, model3, model4, model5, model6)</span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a>model_names <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Lin+Roční"</span>, <span class="st">"Poly+Roční"</span>, <span class="st">"Lin+Roční+Měsíční"</span>, <span class="st">"Poly+Roční+Měsíční"</span>, <span class="st">"Poly+Roční+Měsíční+Týdenní"</span>, <span class="st">"Poly+Roční+Týdenní"</span>)</span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a><span class="co"># AIC a BIC srovnání</span></span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a>comparison <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">Model =</span> model_names,</span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">AIC =</span> <span class="fu">sapply</span>(models, AIC),</span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">BIC =</span> <span class="fu">sapply</span>(models, BIC),</span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">R_squared =</span> <span class="fu">sapply</span>(models, <span class="cf">function</span>(x) <span class="fu">summary</span>(x)<span class="sc">$</span>r.squared)</span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(comparison)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                       Model      AIC      BIC  R_squared
1                  Lin+Roční 8759.225 8776.628 0.07731884
2                 Poly+Roční 8687.252 8708.136 0.32205743
3          Lin+Roční+Měsíční 8762.811 8787.176 0.07890781
4         Poly+Roční+Měsíční 8690.685 8718.530 0.32365865
5 Poly+Roční+Měsíční+Týdenní 8691.944 8723.270 0.32574258
6         Poly+Roční+Týdenní 8688.454 8712.818 0.32430890</code></pre>
</div>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Nejlepší model podle AIC</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>best_func_model <span class="ot">&lt;-</span> models[[<span class="fu">which.min</span>(comparison<span class="sc">$</span>AIC)]]</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">summary</span>(best_func_model))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = new_cases ~ poly(t, 2) + sin_365 + cos_365, data = data)

Residuals:
      Min        1Q    Median        3Q       Max 
-21456740  -8174191  -3504015   2542899 150480019 

Coefficients:
              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)   13630149    1120344  12.166  &lt; 2e-16 ***
poly(t, 2)1  -31590235   17322005  -1.824 0.069467 .  
poly(t, 2)2 -162047697   17593578  -9.211  &lt; 2e-16 ***
sin_365        3952669    1620461   2.439 0.015460 *  
cos_365        6083046    1575171   3.862 0.000146 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 17280000 on 235 degrees of freedom
Multiple R-squared:  0.3221,    Adjusted R-squared:  0.3105 
F-statistic: 27.91 on 4 and 235 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Grafické zobrazení fitování</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>fitted_func <span class="ot">&lt;-</span> <span class="fu">fitted</span>(best_func_model)</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(data, <span class="fu">aes</span>(<span class="at">x =</span> date)) <span class="sc">+</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> new_cases), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> fitted_func), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Nejlepší funkční model"</span>,</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Datum"</span>, <span class="at">y =</span> <span class="st">"Počet případů"</span>,</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"Model:"</span>, model_names[<span class="fu">which.min</span>(comparison<span class="sc">$</span>AIC)])) <span class="sc">+</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="covid_data_analyse_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="3840"></p>
</figure>
</div>
</div>
</div>
<p>Nejlepší funkční model podle AIC je model s polynomiálním trendem a roční sezónností. Model vysvětluje značnou část variability dat.</p>
</section>
<section id="hledání-optimálního-sarima-modelu" class="level2">
<h2 class="anchored" data-anchor-id="hledání-optimálního-sarima-modelu">Hledání optimálního SARIMA modelu</h2>
<section id="kontrola-stacionarity" class="level4">
<h4 class="anchored" data-anchor-id="kontrola-stacionarity">Kontrola stacionarity</h4>
<p><strong>ADF test</strong>: Testuje přítomnost jednotkového kořene.</p>
<p><strong>KPSS test</strong>: Testuje stacionaritu kolem trendu. Pokud je řada nestacionární, aplikujeme diferenciaci.</p>
<p><strong>Stacionární řada</strong>: denní změny (rozdíly) těchto počtů, kolísají kolem nuly bez trendu</p>
<p><strong>Nestacionární řada</strong>: počty covidových případů, mají trend (rostou/klesají), sezónnost (vlny).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Kontrola stacionarity</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>adf_test <span class="ot">&lt;-</span> <span class="fu">adf.test</span>(ts_data)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"ADF test p-hodnota:"</span>, <span class="fu">round</span>(adf_test<span class="sc">$</span>p.value, <span class="dv">4</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "ADF test p-hodnota: 0.3937"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># KPSS test stacionarity</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>kpss_test <span class="ot">&lt;-</span> <span class="fu">kpss.test</span>(ts_data)</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"KPSS test p-hodnota:"</span>, <span class="fu">round</span>(kpss_test<span class="sc">$</span>p.value, <span class="dv">4</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "KPSS test p-hodnota: 0.1"</code></pre>
</div>
</div>
<p>ADF a KPSS testy říkají, že řada je nestacionární, proto se dělá diferenciace. Řada má sezónní trend.</p>
</section>
<section id="pacf-a-acf-grafy" class="level4">
<h4 class="anchored" data-anchor-id="pacf-a-acf-grafy">PACF a ACF grafy</h4>
<p><strong>ACF (Autokorelační funkce)</strong>: Ukazuje míru korelace mezi hodnotami časové řady a jejími zpožděnými verzemi (lagy). Pokud je ACF výrazná u několika lagů, znamená to, že minulost silně ovlivňuje současnost. Postupný pokles ACF může naznačovat MA (moving average) proces.</p>
<p><strong>PACF (Parciální ACF)</strong>: Ukazuje korelaci mezi hodnotami časové řady a jejich lagy po odečtení vlivu mezilehlých lagů. Výrazná hodnota PACF na určitém lagu (např. lag 2) znamená, že tento lag má přímý vliv na současnost. Pokud PACF náhle klesne po určitém lagu, může to naznačovat AR (Autoregressive) proces.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ACF a PACF grafy</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">1</span>))</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="fu">acf</span>(ts_data, <span class="at">main =</span> <span class="st">"ACF původní řady"</span>, <span class="at">lag.max =</span> <span class="dv">100</span>)</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="fu">pacf</span>(ts_data, <span class="at">main =</span> <span class="st">"PACF původní řady"</span>, <span class="at">lag.max =</span> <span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="covid_data_analyse_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="3840"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Diferenciace pokud je potřeba</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(adf_test<span class="sc">$</span>p.value <span class="sc">&gt;</span> <span class="fl">0.05</span>) {</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  ts_diff <span class="ot">&lt;-</span> <span class="fu">diff</span>(ts_data)</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  adf_diff <span class="ot">&lt;-</span> <span class="fu">adf.test</span>(ts_diff)</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"ADF test diferencované řady:"</span>, <span class="fu">round</span>(adf_diff<span class="sc">$</span>p.value, <span class="dv">4</span>)))</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">1</span>))</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">acf</span>(ts_diff, <span class="at">main =</span> <span class="st">"ACF diferencované řady"</span>, <span class="at">lag.max =</span> <span class="dv">100</span>)</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pacf</span>(ts_diff, <span class="at">main =</span> <span class="st">"PACF diferencované řady"</span>, <span class="at">lag.max =</span> <span class="dv">100</span>)</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>  ts_diff <span class="ot">&lt;-</span> ts_data</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "ADF test diferencované řady: 0.01"</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="covid_data_analyse_files/figure-html/unnamed-chunk-9-2.png" class="img-fluid figure-img" width="3840"></p>
</figure>
</div>
</div>
</div>
<p>Data nevykazují silnou závislost na minulých hodnotách (kromě jedné slabé záporné na lag 1). To by mohlo znamenat, že jednoduchý model (např. jen AR(1) nebo dokonce obyčejný průměr) už bude docela dostačující.</p>
</section>
<section id="testování-sarima-kombinací" class="level4">
<h4 class="anchored" data-anchor-id="testování-sarima-kombinací">Testování SARIMA kombinací</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Hledání vhodné SARIMA kombinace...</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Hledání vhodné SARIMA kombinace...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>(auto_sarima_a <span class="ot">&lt;-</span> <span class="fu">auto.arima</span>(ts_data, <span class="at">seasonal =</span> <span class="cn">TRUE</span>)) <span class="co">#sezonní diference Zt = 0.004 + 0156*Zt-1 + 0.09*Et-1 + 0.11*Et-2 - 0.53Zt-1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Series: ts_data 
ARIMA(0,0,0) with non-zero mean 

Coefficients:
          mean
      58721292
s.e.  10847335

sigma^2 = 6.214e+15:  log likelihood = -1097.19
AIC=2198.39   AICc=2198.61   BIC=2202.44</code></pre>
</div>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">BIC</span>(auto_sarima_a)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2202.439</code></pre>
</div>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co">#(auto_sarima_b &lt;- auto.arima(ts_data, ic = "bic"))</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>period <span class="ot">&lt;-</span> <span class="dv">52</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>selected_sarima <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arima</span>(ts_weekly_data, </span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">order =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>),</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">seasonal =</span> <span class="fu">list</span>(<span class="at">order =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="at">period =</span> period))</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>}, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Hlavní SARIMA model selhal:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Jednodušší fallback</span></span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arima</span>(ts_weekly_data, <span class="at">order =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>alternative_sarima <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arima</span>(ts_weekly_data, </span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">order =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">seasonal =</span> <span class="fu">list</span>(<span class="at">order =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>), <span class="at">period =</span> period))</span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a>}, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Alternativní model selhal:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(alternative_sarima)) {</span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a>  aic1 <span class="ot">&lt;-</span> <span class="fu">AIC</span>(selected_sarima)</span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a>  aic2 <span class="ot">&lt;-</span> <span class="fu">AIC</span>(alternative_sarima)</span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-27"><a href="#cb66-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"SARIMA(0, 0, 0)x(0, 0, 0)[52] AIC:"</span>, <span class="fu">round</span>(aic1, <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb66-28"><a href="#cb66-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"SARIMA(0, 0, 1)x(0, 1, 0)[52] AIC:"</span>, <span class="fu">round</span>(aic2, <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb66-29"><a href="#cb66-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-30"><a href="#cb66-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(aic2 <span class="sc">&lt;</span> aic1) {</span>
<span id="cb66-31"><a href="#cb66-31" aria-hidden="true" tabindex="-1"></a>    final_sarima <span class="ot">&lt;-</span> alternative_sarima</span>
<span id="cb66-32"><a href="#cb66-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Lepší je alternativní model.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb66-33"><a href="#cb66-33" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb66-34"><a href="#cb66-34" aria-hidden="true" tabindex="-1"></a>    final_sarima <span class="ot">&lt;-</span> selected_sarima</span>
<span id="cb66-35"><a href="#cb66-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Lepší je původní model.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb66-36"><a href="#cb66-36" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb66-37"><a href="#cb66-37" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb66-38"><a href="#cb66-38" aria-hidden="true" tabindex="-1"></a>  final_sarima <span class="ot">&lt;-</span> selected_sarima</span>
<span id="cb66-39"><a href="#cb66-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Používám původní SARIMA model pro měsíční data.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb66-40"><a href="#cb66-40" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>SARIMA(0, 0, 0)x(0, 0, 0)[52] AIC: 8772.54 
SARIMA(0, 0, 1)x(0, 1, 0)[52] AIC: 6782.3 
Lepší je alternativní model.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Diagnostika residuí</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="fu">checkresiduals</span>(final_sarima)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="covid_data_analyse_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="3840"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Ljung-Box test

data:  Residuals from ARIMA(0,1,0)(0,1,0)[52]
Q* = 70.851, df = 48, p-value = 0.01762

Model df: 0.   Total lags used: 48</code></pre>
</div>
</div>
<p>SARIMA model byl identifikován pomocí automatického vyhledávání. Model zachycuje jak autoregresní chování, tak sezónní komponenty. Diagnostika residuí ukazuje, zda jsou splněny předpoklady modelu.</p>
</section>
</section>
<section id="analýza-závislosti-na-jiných-řadách" class="level2">
<h2 class="anchored" data-anchor-id="analýza-závislosti-na-jiných-řadách">Analýza závislosti na jiných řadách</h2>
<p><strong>Křížová korelační funkce</strong> (CCF): Měří korelaci mezi dvěma časovými řadami při různých zpožděních</p>
<ul>
<li><p><strong>Pozitivní lag</strong>: Y předchází X (Y ovlivňuje budoucí hodnoty X)</p></li>
<li><p><strong>Negativní lag</strong>: X předchází Y (X ovlivňuje budoucí hodnoty Y) Zero lag: Současná korelace</p></li>
</ul>
<p><strong>Testované proměnné</strong>:</p>
<ul>
<li><p><strong>new_deaths</strong> - úmrtí (očekáváme zpoždění za případy)</p></li>
<li><p><strong>stringency_index</strong> - přísnost opatření (může předcházet změnám v případech)</p></li>
<li><p><strong>hosp_patients</strong> - hospitalizace (může následovat za případy)</p></li>
<li><p><strong>reproduction_rate</strong> - reprodukční číslo (může předcházet změnám)</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Příprava dalších časových řad</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>other_series <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"new_deaths"</span>, <span class="st">"stringency_index"</span>, <span class="st">"hosp_patients"</span>, <span class="st">"reproduction_rate"</span>)</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Křížová korelace s různými zpožděními</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>ccf_results <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>max_lag <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(other_series)) {</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>  y_var <span class="ot">&lt;-</span> data[[other_series[i]]]</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>  y_var <span class="ot">&lt;-</span> y_var[<span class="sc">!</span><span class="fu">is.na</span>(y_var)]</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>  x_var <span class="ot">&lt;-</span> data<span class="sc">$</span>new_cases[<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(y_var)]</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>  ccf_result <span class="ot">&lt;-</span> <span class="fu">ccf</span>(x_var, y_var, <span class="at">lag.max =</span> max_lag, </span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>                    <span class="at">main =</span> <span class="fu">paste</span>(<span class="st">"CCF:"</span>, other_series[i]))</span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a>  ccf_results[[other_series[i]]] <span class="ot">&lt;-</span> ccf_result</span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="covid_data_analyse_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="3840"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Identifikace významných korelací</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>significant_lags <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(series <span class="cf">in</span> <span class="fu">names</span>(ccf_results)) {</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>  ccf_vals <span class="ot">&lt;-</span> ccf_results[[series]]<span class="sc">$</span>acf</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>  lags <span class="ot">&lt;-</span> ccf_results[[series]]<span class="sc">$</span>lag</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 95% interval spolehlivosti (přibližně)</span></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(data<span class="sc">$</span>new_cases)</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>  ci <span class="ot">&lt;-</span> <span class="fl">1.96</span><span class="sc">/</span><span class="fu">sqrt</span>(n)</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>  significant_idx <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">abs</span>(ccf_vals) <span class="sc">&gt;</span> ci)</span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(significant_idx) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>    significant_lags[[series]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">lag =</span> lags[significant_idx],</span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">correlation =</span> ccf_vals[significant_idx]</span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Významné korelace pro"</span>, series, <span class="st">":"</span>))</span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">head</span>(significant_lags[[series]]))</span>
<span id="cb71-19"><a href="#cb71-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb71-20"><a href="#cb71-20" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Významné korelace pro new_deaths :"
  lag correlation
1  -4   0.2794442
2  -3   0.3060717
3  -2   0.3411681
4  -1   0.3638755
5   0   0.3579043
6   1   0.3361211
[1] "Významné korelace pro stringency_index :"
  lag correlation
1  -4  -0.2102421
2  -3  -0.1803454
3  -2  -0.1517920
4  -1  -0.1423042
5   0  -0.1864738
6   1  -0.1753981
[1] "Významné korelace pro hosp_patients :"
  lag correlation
1  -4   0.1948951
2  -3   0.2191859
3  -2   0.2508956
4  -1   0.2945856
5   0   0.3488359
6   1   0.4025990
[1] "Významné korelace pro reproduction_rate :"
  lag correlation
1  -4  -0.2715935
2  -3  -0.2761924
3  -2  -0.2836062
4  -1  -0.3066550
5   0  -0.3408848
6   1  -0.3046825</code></pre>
</div>
</div>
</section>
<section id="výsledky" class="level2">
<h2 class="anchored" data-anchor-id="výsledky">Výsledky</h2>
<ul>
<li><strong>new_deaths × new_deaths</strong>
<ul>
<li>Korelace na lag 0 i ±1 je pozitivní a nad hranicí významnosti → úmrtí jsou silně závislá na předchozích hodnotách (autoregrese).</li>
<li>Dává smysl použít zpoždění <code>new_deaths</code> (např. lag 1) jako vysvětlující proměnnou.</li>
</ul></li>
<li><strong>new_deaths × stringency_index</strong>
<ul>
<li>Korelace je malá, téměř všechny sloupce v intervalu - vládní opatření (stringency_index) nemají okamžitou silnou lineární souvislost s denním počtem úmrtí v krátkém horizontu ±4 dní.</li>
</ul></li>
<li><strong>new_deaths × hosp_patients</strong>
<ul>
<li>Výrazně pozitivní korelace na lag 0 a kladných lagech - počet hospitalizovaných je dobrý prediktor úmrtí i pro několik následujících dní.</li>
<li>Určitě má smysl zahrnout hosp_patients (lag 0 nebo 1) do ARIMAX modelu.</li>
</ul></li>
<li><strong>new_deaths × reproduction_rate</strong>
<ul>
<li>Korelace je kolem nuly, uvnitř CI - reprodukční číslo v takto krátkém horizontu přímo neovlivňuje úmrtí (což dává smysl – efekt se projeví až po týdnech).</li>
</ul></li>
</ul>
</section>
<section id="optimální-model-s-externími-regresory-arimax-model" class="level2">
<h2 class="anchored" data-anchor-id="optimální-model-s-externími-regresory-arimax-model">Optimální model s externími regresory (ARIMAX model)</h2>
<p>Kombinace časové dynamiky ARIMA s vlivem externích faktorů. Arimax model zachycuje autokorelaci v datech a současně modeluje vliv dalších proměnných. VAR model místo jednosměrného vztahu (X → Y) modelujeme vzájemné ovlivnění všech proměnných.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Příprava zpožděných proměnných na základě CCF analýzy</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>deaths_lag <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="cn">NA</span>, <span class="dv">1</span>), data<span class="sc">$</span>new_deaths[<span class="dv">1</span><span class="sc">:</span>(<span class="fu">nrow</span>(data)<span class="sc">-</span><span class="dv">1</span>)])</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>stringency_lag <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="cn">NA</span>, <span class="dv">5</span>), data<span class="sc">$</span>stringency_index[<span class="dv">1</span><span class="sc">:</span>(<span class="fu">nrow</span>(data)<span class="sc">-</span><span class="dv">5</span>)])</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>hosp_lag <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="cn">NA</span>, <span class="dv">2</span>), data<span class="sc">$</span>hosp_patients[<span class="dv">1</span><span class="sc">:</span>(<span class="fu">nrow</span>(data)<span class="sc">-</span><span class="dv">2</span>)])</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Model s externími regresory</span></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>external_vars <span class="ot">&lt;-</span> <span class="fu">cbind</span>(</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">deaths_lag =</span> data<span class="sc">$</span>deaths_lag,</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">stringency_lag =</span> data<span class="sc">$</span>stringency_lag,</span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">hosp_lag =</span> data<span class="sc">$</span>hosp_lag</span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Odstranění NA hodnot</span></span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>complete_idx <span class="ot">&lt;-</span> <span class="fu">complete.cases</span>(<span class="fu">cbind</span>(data<span class="sc">$</span>new_cases, external_vars))</span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>ts_complete <span class="ot">&lt;-</span> <span class="fu">ts</span>(data<span class="sc">$</span>new_cases[complete_idx], <span class="at">start =</span> <span class="fu">c</span>(start_year, start_month), <span class="at">frequency =</span> <span class="fl">365.25</span>)</span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a>external_complete <span class="ot">&lt;-</span> external_vars[complete_idx, ]</span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a><span class="co"># ARIMAX model</span></span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a>arimax_model <span class="ot">&lt;-</span> <span class="fu">auto.arima</span>(ts_complete, <span class="at">xreg =</span> external_complete)</span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">summary</span>(arimax_model))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Series: ts_complete 
Regression with ARIMA(0,0,0) errors 

Coefficients:
      intercept  deaths_lag  stringency_lag  hosp_lag
       14233207    -55.8524       -177651.5  5758.587
s.e.    5942829     32.3513        149221.6  1139.905

sigma^2 = 4.12e+14:  log likelihood = -2789.45
AIC=5588.9   AICc=5589.31   BIC=5604.05

Training set error measures:
                        ME     RMSE      MAE       MPE     MAPE MASE      ACF1
Training set -1.565567e-09 20030492 12321194 -417.5056 454.7406  NaN 0.7755844</code></pre>
</div>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(<span class="fu">fitted</span>(arimax_model))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 153</code></pre>
</div>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Srovnání modelů</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Srovnání všech modelů: </span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Srovnání všech modelů: </code></pre>
</div>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>models_comparison <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">Model =</span> <span class="fu">c</span>(<span class="st">"Funkční"</span>, <span class="st">"SARIMA"</span>, <span class="st">"ARIMAX"</span>),</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">AIC =</span> <span class="fu">c</span>(<span class="fu">AIC</span>(best_func_model), <span class="fu">AIC</span>(final_sarima), <span class="fu">AIC</span>(arimax_model)),</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">BIC =</span> <span class="fu">c</span>(<span class="fu">BIC</span>(best_func_model), <span class="fu">BIC</span>(final_sarima), <span class="fu">BIC</span>(arimax_model))</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(models_comparison)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Model      AIC      BIC
1 Funkční 8687.252 8708.136
2  SARIMA 6782.302 6785.533
3  ARIMAX 5588.902 5604.054</code></pre>
</div>
</div>
<p>ARIMAX model kombinuje autoregresní chování s vlivem externích proměnných.</p>
<section id="kontrola-předpokladů-regresních-modelů" class="level4">
<h4 class="anchored" data-anchor-id="kontrola-předpokladů-regresních-modelů">Kontrola předpokladů regresních modelů</h4>
<p>Zde ověříme, zda naše modely splňují předpoklady, jako je nezávislost reziduí, heteroskedasticita (konstantní rozptyl), normalita reziduí a Ljung-Box test.</p>
<p>Při porušení předpokladů se dělá:</p>
<ul>
<li><p>Autokorelace: Zvýšení řádu ARIMA modelu.</p></li>
<li><p>Nenormalita: Transformace dat nebo robustní metody.</p></li>
<li><p>Heteroskedasticita: GARCH modely nebo weighted regression.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Diagnostika residuí pro všechny modely</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>models_to_check <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Funkční"</span> <span class="ot">=</span> best_func_model,</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SARIMA"</span> <span class="ot">=</span> final_sarima,</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ARIMAX"</span> <span class="ot">=</span> arimax_model</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(model_name <span class="cf">in</span> <span class="fu">names</span>(models_to_check)) {</span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> models_to_check[[model_name]]</span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">inherits</span>(model, <span class="st">"lm"</span>)) {</span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>    residuals <span class="ot">&lt;-</span> <span class="fu">residuals</span>(model)</span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a>    residuals <span class="ot">&lt;-</span> <span class="fu">residuals</span>(model)</span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ACF residuí</span></span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">acf</span>(residuals, <span class="at">main =</span> <span class="fu">paste</span>(<span class="st">"ACF residuí -"</span>, model_name), <span class="at">lag.max =</span> <span class="dv">50</span>)</span>
<span id="cb81-20"><a href="#cb81-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ljung-Box test</span></span>
<span id="cb81-21"><a href="#cb81-21" aria-hidden="true" tabindex="-1"></a>  lb_test <span class="ot">&lt;-</span> <span class="fu">Box.test</span>(residuals, <span class="at">lag =</span> <span class="dv">20</span>, <span class="at">type =</span> <span class="st">"Ljung-Box"</span>)</span>
<span id="cb81-22"><a href="#cb81-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste</span>(model_name, <span class="st">"- Ljung-Box test p-hodnota:"</span>, <span class="fu">round</span>(lb_test<span class="sc">$</span>p.value, <span class="dv">4</span>)))</span>
<span id="cb81-23"><a href="#cb81-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Normalita residuí</span></span>
<span id="cb81-24"><a href="#cb81-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb81-25"><a href="#cb81-25" aria-hidden="true" tabindex="-1"></a>shapiro_test <span class="ot">&lt;-</span> <span class="fu">shapiro.test</span>(<span class="fu">sample</span>(residuals, <span class="fu">min</span>(<span class="dv">5000</span>, <span class="fu">length</span>(residuals))))</span>
<span id="cb81-26"><a href="#cb81-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-27"><a href="#cb81-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste</span>(model_name, <span class="st">"- Shapiro test p-hodnota:"</span>, <span class="fu">round</span>(shapiro_test<span class="sc">$</span>p.value, <span class="dv">4</span>)))</span>
<span id="cb81-28"><a href="#cb81-28" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Funkční - Ljung-Box test p-hodnota: 0"
[1] "Funkční - Shapiro test p-hodnota: 0"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "SARIMA - Ljung-Box test p-hodnota: 4e-04"
[1] "SARIMA - Shapiro test p-hodnota: 0"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "ARIMAX - Ljung-Box test p-hodnota: 0"
[1] "ARIMAX - Shapiro test p-hodnota: 0"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="co"># QQ plots pro normalitu</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="covid_data_analyse_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="3840"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(model_name <span class="cf">in</span> <span class="fu">names</span>(models_to_check)) {</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> models_to_check[[model_name]]</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>  residuals <span class="ot">&lt;-</span> <span class="fu">residuals</span>(model)</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">qqnorm</span>(residuals, <span class="at">main =</span> <span class="fu">paste</span>(<span class="st">"Q-Q plot -"</span>, model_name))</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">qqline</span>(residuals)</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="covid_data_analyse_files/figure-html/unnamed-chunk-13-2.png" class="img-fluid figure-img" width="3840"></p>
</figure>
</div>
</div>
</div>
<p>Kontrola ukazuje, zda jsou splněny základní předpoklady modelů - nezávislost residuí (ACF, Ljung-Box test) a jejich normalita (Shapiro test, Q-Q ploty).</p>
</section>
</section>
<section id="predikce-budoucích-hodnot" class="level2">
<h2 class="anchored" data-anchor-id="predikce-budoucích-hodnot">Predikce budoucích hodnot</h2>
<p>Zde otestujeme predikční schopnost jednotlivých modelů a porovnáme jejich výkon na 10 období do budoucna.</p>
<p>Srovnáme Funkční model, SARIMA model a ARIMAX model. Vytvoříme Grafické srovnání modelů a kvantitativní hodnocení.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Predikce na 10 období dopředu</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>horizon <span class="ot">&lt;-</span> <span class="dv">52</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Kontrola kvality modelů před predikcí</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Kontrola SARIMA modelu:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Kontrola SARIMA modelu:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Koeficienty:"</span>, <span class="fu">coef</span>(final_sarima), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Koeficienty:  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Sigma2:"</span>, final_sarima<span class="sc">$</span>sigma2, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sigma2: 3.268173e+14 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Loglik:"</span>, final_sarima<span class="sc">$</span>loglik, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loglik: -3390.151 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Kontrola časové řady</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Kontrola časové řady pro predikci:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Kontrola časové řady pro predikci:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Délka:"</span>, <span class="fu">length</span>(ts_data), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Délka: 56 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Start:"</span>, <span class="fu">paste</span>(<span class="fu">start</span>(ts_data), <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Start: 2020, 1 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Frequency:"</span>, <span class="fu">frequency</span>(ts_data), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Frequency: 12 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Posledních 5 hodnot:"</span>, <span class="fu">tail</span>(ts_data, <span class="dv">5</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Posledních 5 hodnot: 601461 557549 811610 906906 214317 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Funkční model predikce</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>future_t <span class="ot">&lt;-</span> (<span class="fu">nrow</span>(data)<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(<span class="fu">nrow</span>(data)<span class="sc">+</span>horizon)</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>future_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">t =</span> future_t,</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">sin_365 =</span> <span class="fu">sin</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> future_t <span class="sc">/</span> <span class="fl">365.25</span>),</span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">cos_365 =</span> <span class="fu">cos</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> future_t <span class="sc">/</span> <span class="fl">365.25</span>),</span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">sin_7 =</span> <span class="fu">sin</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> future_t <span class="sc">/</span> <span class="dv">7</span>),</span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">cos_7 =</span> <span class="fu">cos</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> future_t <span class="sc">/</span> <span class="dv">7</span>)</span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Jednoduchá predikce bez složitého rozlišování modelů</span></span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a>pred_func <span class="ot">&lt;-</span> <span class="fu">predict</span>(best_func_model, <span class="at">newdata =</span> future_data, <span class="at">interval =</span> <span class="st">"prediction"</span>)</span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Funkční model - predikce dokončena</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Funkční model - predikce dokončena</code></pre>
</div>
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="co"># SARIMA predikce</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">is.null</span>(final_sarima) <span class="sc">||</span> <span class="fu">any</span>(<span class="fu">is.na</span>(<span class="fu">coef</span>(final_sarima)))) {</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"SARIMA model je nevalidní! Vytvářím nový jednoduchý model...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>  simple_ts <span class="ot">&lt;-</span> <span class="fu">ts</span>(data<span class="sc">$</span>new_cases[<span class="sc">!</span><span class="fu">is.na</span>(data<span class="sc">$</span>new_cases)], <span class="at">frequency =</span> <span class="dv">1</span>)</span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>  final_sarima <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arima</span>(simple_ts, <span class="at">order =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"I jednoduchý ARIMA selhal:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arima</span>(simple_ts, <span class="at">order =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>))  <span class="co"># random walk</span></span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb107-12"><a href="#cb107-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-13"><a href="#cb107-13" aria-hidden="true" tabindex="-1"></a>pred_sarima <span class="ot">&lt;-</span> <span class="fu">forecast</span>(final_sarima, <span class="at">h =</span> horizon)</span>
<span id="cb107-14"><a href="#cb107-14" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"SARIMA predikce dokončena</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>SARIMA predikce dokončena</code></pre>
</div>
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ARIMAX predikce (potřebujeme budoucí hodnoty externích proměnných)</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Pro zjednodušení použijeme poslední dostupné hodnoty</span></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>last_external <span class="ot">&lt;-</span> external_complete[<span class="fu">nrow</span>(external_complete), , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>future_external <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rep</span>(<span class="fu">as.numeric</span>(last_external), horizon), </span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>                          <span class="at">nrow =</span> horizon, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(future_external) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(external_complete)</span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Názvy sloupců v trénovacích datech:"</span>, <span class="fu">colnames</span>(external_complete), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Názvy sloupců v trénovacích datech: deaths_lag stringency_lag hosp_lag </code></pre>
</div>
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Názvy sloupců v predikčních datech:"</span>, <span class="fu">colnames</span>(future_external), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Názvy sloupců v predikčních datech: deaths_lag stringency_lag hosp_lag </code></pre>
</div>
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>pred_arimax <span class="ot">=</span> <span class="fu">forecast</span>(arimax_model, <span class="at">xreg =</span> future_external, <span class="at">h =</span> horizon)</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"ARIMAX predikce dokončena</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ARIMAX predikce dokončena</code></pre>
</div>
</div>
<section id="grafické-srovnání-a-hodnocení-modelů" class="level4">
<h4 class="anchored" data-anchor-id="grafické-srovnání-a-hodnocení-modelů">Grafické srovnání a hodnocení modelů</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(data<span class="sc">$</span>date, <span class="dv">1</span>)        <span class="co"># poslední datum v datech</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2024-08-04"</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Grafické zobrazení predikcí</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>future_dates <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">max</span>(data<span class="sc">$</span>date) <span class="sc">+</span> <span class="dv">1</span>, <span class="at">by =</span> <span class="st">"day"</span>, <span class="at">length.out =</span> horizon)</span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Budoucí data:"</span>, <span class="fu">as.character</span>(future_dates[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]), <span class="st">"...</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Budoucí data: 2024-08-05 2024-08-06 2024-08-07 ...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === KONTROLA PŘED GRAFEM ===</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== FINÁLNÍ KONTROLA ===</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
=== FINÁLNÍ KONTROLA ===</code></pre>
</div>
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Funkční - rozsah:"</span>, <span class="fu">range</span>(pred_func[,<span class="dv">1</span>]), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Funkční - rozsah: -53289530 -20200452 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"SARIMA - rozsah:"</span>, <span class="fu">range</span>(pred_sarima<span class="sc">$</span>mean), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>SARIMA - rozsah: -2480551 -930149 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"ARIMAX - rozsah:"</span>, <span class="fu">range</span>(pred_arimax<span class="sc">$</span>mean), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ARIMAX - rozsah: 30478627 30478627 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test na nuly</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">all</span>(pred_sarima<span class="sc">$</span>mean <span class="sc">==</span> <span class="dv">0</span>)) {</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"PROBLÉM: SARIMA predikuje samé nuly!</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Poslední hodnota v časové řadě:"</span>, <span class="fu">tail</span>(<span class="fu">as.numeric</span>(ts_data), <span class="dv">1</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Model summary:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">summary</span>(final_sarima))</span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Oprava: použij poslední hodnotu</span></span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a>  pred_sarima<span class="sc">$</span>mean <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">tail</span>(<span class="fu">as.numeric</span>(ts_data), <span class="dv">1</span>), horizon)</span>
<span id="cb127-9"><a href="#cb127-9" aria-hidden="true" tabindex="-1"></a>  pred_sarima<span class="sc">$</span>lower[,<span class="dv">2</span>] <span class="ot">&lt;-</span> pred_sarima<span class="sc">$</span>mean <span class="sc">*</span> <span class="fl">0.8</span></span>
<span id="cb127-10"><a href="#cb127-10" aria-hidden="true" tabindex="-1"></a>  pred_sarima<span class="sc">$</span>upper[,<span class="dv">2</span>] <span class="ot">&lt;-</span> pred_sarima<span class="sc">$</span>mean <span class="sc">*</span> <span class="fl">1.2</span></span>
<span id="cb127-11"><a href="#cb127-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb127-12"><a href="#cb127-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-13"><a href="#cb127-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-14"><a href="#cb127-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Určíme počet historických pozorování k zobrazení (posledních 24 měsíců nebo méně)</span></span>
<span id="cb127-15"><a href="#cb127-15" aria-hidden="true" tabindex="-1"></a>last_n_obs <span class="ot">&lt;-</span> <span class="dv">136</span></span>
<span id="cb127-16"><a href="#cb127-16" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Zobrazím posledních"</span>, last_n_obs, <span class="st">"měsíčních pozorování</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Zobrazím posledních 136 měsíčních pozorování</code></pre>
</div>
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(data) <span class="sc">&lt;</span> last_n_obs) last_n_obs <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data);</span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Historická data</span></span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>historical_dates <span class="ot">&lt;-</span> <span class="fu">tail</span>(data<span class="sc">$</span>date, last_n_obs)</span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a>historical_values <span class="ot">&lt;-</span> <span class="fu">tail</span>(data<span class="sc">$</span>new_cases, last_n_obs)</span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Kontrola, že predikce mají správnou délku a nejsou NA</span></span>
<span id="cb129-9"><a href="#cb129-9" aria-hidden="true" tabindex="-1"></a>pred_func_clean <span class="ot">&lt;-</span> pred_func[,<span class="dv">1</span>]</span>
<span id="cb129-10"><a href="#cb129-10" aria-hidden="true" tabindex="-1"></a>pred_func_lower <span class="ot">&lt;-</span> pred_func[,<span class="dv">2</span>] </span>
<span id="cb129-11"><a href="#cb129-11" aria-hidden="true" tabindex="-1"></a>pred_func_upper <span class="ot">&lt;-</span> pred_func[,<span class="dv">3</span>]</span>
<span id="cb129-12"><a href="#cb129-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-13"><a href="#cb129-13" aria-hidden="true" tabindex="-1"></a>pred_sarima_clean <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(pred_sarima<span class="sc">$</span>mean)</span>
<span id="cb129-14"><a href="#cb129-14" aria-hidden="true" tabindex="-1"></a>pred_sarima_lower <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(pred_sarima<span class="sc">$</span>lower[,<span class="dv">2</span>])</span>
<span id="cb129-15"><a href="#cb129-15" aria-hidden="true" tabindex="-1"></a>pred_sarima_upper <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(pred_sarima<span class="sc">$</span>upper[,<span class="dv">2</span>])</span>
<span id="cb129-16"><a href="#cb129-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-17"><a href="#cb129-17" aria-hidden="true" tabindex="-1"></a>pred_arimax_clean <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(pred_arimax<span class="sc">$</span>mean)</span>
<span id="cb129-18"><a href="#cb129-18" aria-hidden="true" tabindex="-1"></a>pred_arimax_lower <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(pred_arimax<span class="sc">$</span>lower[,<span class="dv">2</span>])</span>
<span id="cb129-19"><a href="#cb129-19" aria-hidden="true" tabindex="-1"></a>pred_arimax_upper <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(pred_arimax<span class="sc">$</span>upper[,<span class="dv">2</span>])</span>
<span id="cb129-20"><a href="#cb129-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-21"><a href="#cb129-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Náhrada NA hodnotami z SARIMA predikce pokud je potřeba</span></span>
<span id="cb129-22"><a href="#cb129-22" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">is.na</span>(pred_func_clean))) {</span>
<span id="cb129-23"><a href="#cb129-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Opravuji NA v funkčních predikcích</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb129-24"><a href="#cb129-24" aria-hidden="true" tabindex="-1"></a>  pred_func_clean[<span class="fu">is.na</span>(pred_func_clean)] <span class="ot">&lt;-</span> pred_sarima<span class="sc">$</span>mean[<span class="fu">is.na</span>(pred_func_clean)]</span>
<span id="cb129-25"><a href="#cb129-25" aria-hidden="true" tabindex="-1"></a>  pred_func_lower[<span class="fu">is.na</span>(pred_func_lower)] <span class="ot">&lt;-</span> pred_sarima<span class="sc">$</span>lower[<span class="fu">is.na</span>(pred_func_lower),<span class="dv">2</span>]</span>
<span id="cb129-26"><a href="#cb129-26" aria-hidden="true" tabindex="-1"></a>  pred_func_upper[<span class="fu">is.na</span>(pred_func_upper)] <span class="ot">&lt;-</span> pred_sarima<span class="sc">$</span>upper[<span class="fu">is.na</span>(pred_func_upper),<span class="dv">2</span>]</span>
<span id="cb129-27"><a href="#cb129-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb129-28"><a href="#cb129-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-29"><a href="#cb129-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Vytvoření clean dat pro ggplot</span></span>
<span id="cb129-30"><a href="#cb129-30" aria-hidden="true" tabindex="-1"></a>plot_data_clean <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb129-31"><a href="#cb129-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">date =</span> <span class="fu">c</span>(historical_dates, future_dates),</span>
<span id="cb129-32"><a href="#cb129-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">actual =</span> <span class="fu">c</span>(historical_values, <span class="fu">rep</span>(<span class="cn">NA</span>, horizon)),</span>
<span id="cb129-33"><a href="#cb129-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb129-34"><a href="#cb129-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Funkční model</span></span>
<span id="cb129-35"><a href="#cb129-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">func_pred =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="cn">NA</span>, last_n_obs), pred_func_clean),</span>
<span id="cb129-36"><a href="#cb129-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">func_lower =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="cn">NA</span>, last_n_obs), pred_func_lower),</span>
<span id="cb129-37"><a href="#cb129-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">func_upper =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="cn">NA</span>, last_n_obs), pred_func_upper),</span>
<span id="cb129-38"><a href="#cb129-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb129-39"><a href="#cb129-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># SARIMA model  </span></span>
<span id="cb129-40"><a href="#cb129-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">sarima_pred =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="cn">NA</span>, last_n_obs), <span class="fu">as.numeric</span>(pred_sarima<span class="sc">$</span>mean)),</span>
<span id="cb129-41"><a href="#cb129-41" aria-hidden="true" tabindex="-1"></a>  <span class="at">sarima_lower =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="cn">NA</span>, last_n_obs), <span class="fu">as.numeric</span>(pred_sarima<span class="sc">$</span>lower[,<span class="dv">2</span>])),</span>
<span id="cb129-42"><a href="#cb129-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">sarima_upper =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="cn">NA</span>, last_n_obs), <span class="fu">as.numeric</span>(pred_sarima<span class="sc">$</span>upper[,<span class="dv">2</span>])),</span>
<span id="cb129-43"><a href="#cb129-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb129-44"><a href="#cb129-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ARIMAX model</span></span>
<span id="cb129-45"><a href="#cb129-45" aria-hidden="true" tabindex="-1"></a>  <span class="at">arimax_pred =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="cn">NA</span>, last_n_obs), <span class="fu">as.numeric</span>(pred_arimax<span class="sc">$</span>mean)),</span>
<span id="cb129-46"><a href="#cb129-46" aria-hidden="true" tabindex="-1"></a>  <span class="at">arimax_lower =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="cn">NA</span>, last_n_obs), <span class="fu">as.numeric</span>(pred_arimax<span class="sc">$</span>lower[,<span class="dv">2</span>])),</span>
<span id="cb129-47"><a href="#cb129-47" aria-hidden="true" tabindex="-1"></a>  <span class="at">arimax_upper =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="cn">NA</span>, last_n_obs), <span class="fu">as.numeric</span>(pred_arimax<span class="sc">$</span>upper[,<span class="dv">2</span>]))</span>
<span id="cb129-48"><a href="#cb129-48" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb129-49"><a href="#cb129-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-50"><a href="#cb129-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Kontrola finálních dat</span></span>
<span id="cb129-51"><a href="#cb129-51" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Kontrola plot_data_clean:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Kontrola plot_data_clean:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Počet řádků:"</span>, <span class="fu">nrow</span>(plot_data_clean), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Počet řádků: 188 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"NA v actual:"</span>, <span class="fu">sum</span>(<span class="fu">is.na</span>(plot_data_clean<span class="sc">$</span>actual)), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA v actual: 52 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"NA v func_pred:"</span>, <span class="fu">sum</span>(<span class="fu">is.na</span>(plot_data_clean<span class="sc">$</span>func_pred)), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA v func_pred: 136 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"NA v sarima_pred:"</span>, <span class="fu">sum</span>(<span class="fu">is.na</span>(plot_data_clean<span class="sc">$</span>sarima_pred)), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA v sarima_pred: 136 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Vylepšený graf predikcí</span></span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>prediction_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(plot_data_clean, <span class="fu">aes</span>(<span class="at">x =</span> date)) <span class="sc">+</span></span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Historická data - body a čáry</span></span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> actual), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="fl">1.2</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> actual), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb139-6"><a href="#cb139-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Funkční model</span></span>
<span id="cb139-7"><a href="#cb139-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> func_pred), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="fl">1.2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb139-8"><a href="#cb139-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> func_pred), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb139-9"><a href="#cb139-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> func_lower, <span class="at">ymax =</span> func_upper), <span class="at">fill =</span> <span class="st">"red"</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb139-10"><a href="#cb139-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># SARIMA model</span></span>
<span id="cb139-11"><a href="#cb139-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> sarima_pred), <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">size =</span> <span class="fl">1.2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb139-12"><a href="#cb139-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> sarima_pred), <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">size =</span> <span class="dv">2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb139-13"><a href="#cb139-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> sarima_lower, <span class="at">ymax =</span> sarima_upper), <span class="at">fill =</span> <span class="st">"blue"</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb139-14"><a href="#cb139-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ARIMAX model</span></span>
<span id="cb139-15"><a href="#cb139-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> arimax_pred), <span class="at">color =</span> <span class="st">"green"</span>, <span class="at">size =</span> <span class="fl">1.2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb139-16"><a href="#cb139-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> arimax_pred), <span class="at">color =</span> <span class="st">"green"</span>, <span class="at">size =</span> <span class="dv">2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb139-17"><a href="#cb139-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> arimax_lower, <span class="at">ymax =</span> arimax_upper), <span class="at">fill =</span> <span class="st">"green"</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb139-18"><a href="#cb139-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Vertikální čára oddělující historii od predikcí</span></span>
<span id="cb139-19"><a href="#cb139-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">max</span>(historical_dates), <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">color =</span> <span class="st">"gray50"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb139-20"><a href="#cb139-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Lepší popisky a téma</span></span>
<span id="cb139-21"><a href="#cb139-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Predikce měsíčních nových případů - srovnání modelů"</span>, <span class="at">x =</span> <span class="st">"Datum"</span>, <span class="at">y =</span> <span class="st">"Počet případů (měsíčně)"</span>,</span>
<span id="cb139-22"><a href="#cb139-22" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"Historická data (černá) | Predikce: Funkční (červená), SARIMA (modrá), ARIMAX (zelená)"</span>, <span class="st">"</span><span class="sc">\n</span><span class="st">Přerušovaná čára označuje konec historických dat"</span>)) <span class="sc">+</span></span>
<span id="cb139-23"><a href="#cb139-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb139-24"><a href="#cb139-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>, <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">"bold"</span>), <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb139-25"><a href="#cb139-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>), <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>())</span>
<span id="cb139-26"><a href="#cb139-26" aria-hidden="true" tabindex="-1"></a><span class="co">#  # Rozumné limity osy y</span></span>
<span id="cb139-27"><a href="#cb139-27" aria-hidden="true" tabindex="-1"></a><span class="co">#  + coord_cartesian(ylim = c(0, max(c(historical_values, #pred_func_clean, pred_sarima, pred_arimax_clean), na.rm = TRUE) * #1.1))</span></span>
<span id="cb139-28"><a href="#cb139-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-29"><a href="#cb139-29" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(prediction_plot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="covid_data_analyse_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="3840"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Číselný souhrn predikcí</span></span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== ČÍSELNÉ PREDIKCE (měsíční hodnoty) ===</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
=== ČÍSELNÉ PREDIKCE (měsíční hodnoty) ===</code></pre>
</div>
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a>predictions_summary <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(Měsíc <span class="ot">=</span> future_dates, Funkční <span class="ot">=</span> <span class="fu">round</span>(pred_func_clean, <span class="dv">0</span>), <span class="at">SARIMA =</span> <span class="fu">round</span>(pred_sarima_clean, <span class="dv">0</span>), <span class="at">ARIMAX =</span> <span class="fu">round</span>(pred_arimax_clean, <span class="dv">0</span>))</span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Predikce na příštích 10 měsíců:"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Predikce na příštích 10 měsíců:"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(predictions_summary)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        Měsíc   Funkční   SARIMA   ARIMAX
1  2024-08-05 -20200452 -2053607 30478627
2  2024-08-06 -20766756 -1210580 30478627
3  2024-08-07 -21335995 -1147630 30478627
4  2024-08-08 -21908187 -1207603 30478627
5  2024-08-09 -22483346 -1622901 30478627
6  2024-08-10 -23061492 -2056629 30478627
7  2024-08-11 -23642641 -1981695 30478627
8  2024-08-12 -24226813 -1896665 30478627
9  2024-08-13 -24814025 -1854840 30478627
10 2024-08-14 -25404298 -1926817 30478627
11 2024-08-15 -25997652 -1977512 30478627
12 2024-08-16 -26594107 -1972632 30478627
13 2024-08-17 -27193685 -1912953 30478627
14 2024-08-18 -27796406 -1837363 30478627
15 2024-08-19 -28402294 -1696573 30478627
16 2024-08-20 -29011371 -1560766 30478627
17 2024-08-21 -29623659 -1369674 30478627
18 2024-08-22 -30239183 -1148641 30478627
19 2024-08-23 -30857967  -930149 30478627
20 2024-08-24 -31480035 -1049894 30478627
21 2024-08-25 -32105412 -1469704 30478627
22 2024-08-26 -32734125 -1736011 30478627
23 2024-08-27 -33366198 -1812368 30478627
24 2024-08-28 -34001659 -2025112 30478627
25 2024-08-29 -34640533 -2120277 30478627
26 2024-08-30 -35282850 -2189229 30478627
27 2024-08-31 -35928635 -2238006 30478627
28 2024-09-01 -36577918 -2282933 30478627
29 2024-09-02 -37230727 -2294085 30478627
30 2024-09-03 -37887091 -2315012 30478627
31 2024-09-04 -38547039 -2360162 30478627
32 2024-09-05 -39210601 -2372205 30478627
33 2024-09-06 -39877807 -2401935 30478627
34 2024-09-07 -40548687 -2149020 30478627
35 2024-09-08 -41223273 -2443902 30478627
36 2024-09-09 -41901595 -2445859 30478627
37 2024-09-10 -42583685 -2476011 30478627
38 2024-09-11 -43269575 -2466647 30478627
39 2024-09-12 -43959297 -2480551 30478627
40 2024-09-13 -44652884 -2468093 30478627
41 2024-09-14 -45350367 -2452368 30478627
42 2024-09-15 -46051781 -2475319 30478627
43 2024-09-16 -46757158 -2463208 30478627
44 2024-09-17 -47466532 -2457996 30478627
45 2024-09-18 -48179937 -2453992 30478627
46 2024-09-19 -48897407 -2447775 30478627
47 2024-09-20 -49618976 -2407769 30478627
48 2024-09-21 -50344680 -2403424 30478627
49 2024-09-22 -51074552 -2400480 30478627
50 2024-09-23 -51808627 -2372106 30478627
51 2024-09-24 -52546941 -2350964 30478627
52 2024-09-25 -53289530 -2394153 30478627</code></pre>
</div>
</div>
<p>Srovnání ukazuje rozdíly mezi jednotlivými přístupy. SARIMA model ukazuje nejlepší výsledek.</p>
</section>
</section>
<section id="závěrečné-srovnání-a-doporučení" class="level2">
<h2 class="anchored" data-anchor-id="závěrečné-srovnání-a-doporučení">Závěrečné srovnání a doporučení</h2>
<p>Zhodnocení všech testovaných přístupů a formulace doporučení pro praxi.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Finální srovnání všech modelů</span></span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>final_comparison <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">Model =</span> <span class="fu">c</span>(<span class="st">"Funkční (trend+sezónost)"</span>, <span class="st">"SARIMA"</span>, <span class="st">"ARIMAX"</span>),</span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">AIC =</span> <span class="fu">c</span>(<span class="fu">AIC</span>(best_func_model), <span class="fu">AIC</span>(final_sarima), <span class="fu">AIC</span>(arimax_model)),</span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">BIC =</span> <span class="fu">c</span>(<span class="fu">BIC</span>(best_func_model), <span class="fu">BIC</span>(final_sarima), <span class="fu">BIC</span>(arimax_model)),</span>
<span id="cb146-6"><a href="#cb146-6" aria-hidden="true" tabindex="-1"></a>  Parametrů <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">length</span>(<span class="fu">coef</span>(best_func_model)), </span>
<span id="cb146-7"><a href="#cb146-7" aria-hidden="true" tabindex="-1"></a>                <span class="fu">length</span>(<span class="fu">coef</span>(final_sarima)),</span>
<span id="cb146-8"><a href="#cb146-8" aria-hidden="true" tabindex="-1"></a>                <span class="fu">length</span>(<span class="fu">coef</span>(arimax_model))),</span>
<span id="cb146-9"><a href="#cb146-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">RMSE =</span> <span class="fu">c</span>(</span>
<span id="cb146-10"><a href="#cb146-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sqrt</span>(<span class="fu">mean</span>(<span class="fu">residuals</span>(best_func_model)<span class="sc">^</span><span class="dv">2</span>)),</span>
<span id="cb146-11"><a href="#cb146-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sqrt</span>(<span class="fu">mean</span>(<span class="fu">residuals</span>(final_sarima)<span class="sc">^</span><span class="dv">2</span>)),</span>
<span id="cb146-12"><a href="#cb146-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sqrt</span>(<span class="fu">mean</span>(<span class="fu">residuals</span>(arimax_model)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb146-13"><a href="#cb146-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb146-14"><a href="#cb146-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb146-15"><a href="#cb146-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-16"><a href="#cb146-16" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Finální srovnání modelů:"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Finální srovnání modelů:"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(final_comparison)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                     Model      AIC      BIC Parametrů     RMSE
1 Funkční (trend+sezónost) 8687.252 8708.136         5 17098534
2                   SARIMA 6782.302 6785.533         0 15957606
3                   ARIMAX 5588.902 5604.054         4 20030492</code></pre>
</div>
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Doporučení nejlepšího modelu</span></span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>best_model_idx <span class="ot">&lt;-</span> <span class="fu">which.min</span>(final_comparison<span class="sc">$</span>AIC)</span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a>best_model_name <span class="ot">&lt;-</span> final_comparison<span class="sc">$</span>Model[best_model_idx]</span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== DOPORUČENÍ ===</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
=== DOPORUČENÍ ===</code></pre>
</div>
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Nejlepší model podle AIC:"</span>, best_model_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Nejlepší model podle AIC: ARIMAX </code></pre>
</div>
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"AIC:"</span>, <span class="fu">round</span>(final_comparison<span class="sc">$</span>AIC[best_model_idx], <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>AIC: 5588.9 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"RMSE:"</span>, <span class="fu">round</span>(final_comparison<span class="sc">$</span>RMSE[best_model_idx], <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>RMSE: 20030492 </code></pre>
</div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>